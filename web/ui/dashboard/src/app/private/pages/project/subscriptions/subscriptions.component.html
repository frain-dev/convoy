<div class="text-12 font-medium uppercase flex items-center">
	<a routerLink="/projects" class="cursor-pointer">Projects</a>
	<svg width="16" height="16" class="mx-1">
		<use xlink:href="#arrow-right-icon"></use>
	</svg>
	{{ privateService.activeProjectDetails?.name }}
	<svg width="16" height="16" class="mx-1">
		<use xlink:href="#arrow-right-icon"></use>
	</svg>
	<span class="text-primary-100">SUBSCRIPTIONS</span>
</div>

<div class="flex justify-between items-end mt-24px border-b border-b-grey-10 pb-20px mb-24px">
	<div>
		<h1 class="text-24 font-bold text-grey-80">Subscriptions</h1>
		<p class="text-grey-60 text-14 mt-6px">List of your source to endpoint connections</p>
	</div>
	<button convoy-button size="sm" routerLink="./new">Create a subscription</button>
</div>

<!-- subscriptions loader  -->
<div class="flex flex-wrap gap-24px" *ngIf="privateService.activeProjectDetails?.type === 'incoming' && isLoadindingSubscriptions">
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-348px h-136px"></div>
</div>

<div class="flex flex-wrap gap-24px" *ngIf="privateService.activeProjectDetails?.type === 'outgoing' && isLoadindingSubscriptions">
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
	<div class="bg-grey-10 rounded-8px animate-pulse w-full h-122px"></div>
</div>

<div *ngIf="!isLoadindingSubscriptions && subscriptions?.content?.length">
	<div class="flex flex-wrap gap-24px" *ngIf="privateService.activeProjectDetails?.type === 'incoming'">
		<div convoy-card class="py-20px transition-all outline-none w-full max-w-[356px] cursor-pointer" hover="true" *ngFor="let subscription of subscriptions?.content; let i = index" [id]="'app' + i" [routerLink]="['./']" [queryParams]="{ id: subscription.uid }">
			<div class="px-24px pb-12px border-b border-b-grey-10 flex items-center justify-between">
				<div class="w-114px">
					<div class="text-grey-40 text-10 mb-4px">{{ subscription.source_metadata.provider || (subscription.source_metadata.verifier.type | sourceValue: 'verifier') }} Source</div>
					<div class="text-14 font-medium text-grey-60 overflow-hidden" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical">{{ subscription.source_metadata.name }}</div>
				</div>
				<div class="flex items-center justify-center">
					<svg width="30" height="9" viewBox="0 0 30 9" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path
							d="M0.647711 3.89014C0.451813 4.08191 0.450731 4.39849 0.645295 4.59724L3.81589 7.83601C4.01046 8.03476 4.32699 8.04041 4.52289 7.84864C4.71878 7.65686 4.71987 7.34028 4.5253 7.14154L1.70699 4.26262L4.54464 1.48471C4.74054 1.29294 4.74162 0.976359 4.54705 0.777611C4.35249 0.578864 4.03596 0.573212 3.84006 0.764986L0.647711 3.89014ZM29.3523 5.10986C29.5482 4.91809 29.5493 4.60151 29.3547 4.40276L26.1841 1.16399C25.9895 0.96524 25.673 0.959588 25.4771 1.15136C25.2812 1.34314 25.2801 1.65972 25.4747 1.85846L28.293 4.73738L25.4554 7.51529C25.2595 7.70706 25.2584 8.02364 25.4529 8.22239C25.6475 8.42114 25.964 8.42679 26.1599 8.23501L29.3523 5.10986ZM0.998291 4.75L28.9983 5.25L29.0017 4.25L1.00171 3.75L0.998291 4.75Z"
							fill="#E8E8E9"
						/>
					</svg>
				</div>
				<div class="text-right w-114px">
					<div class="text-grey-40 text-10 mb-4px">Endpoint</div>
					<div class="text-14 font-medium text-grey-60 overflow-hidden" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical">{{ subscription.endpoint_metadata?.title }}</div>
				</div>
			</div>

			<div class="mt-12px mx-24px flex justify-between">
				<div class="flex flex-col items-center text-grey-60" [ngClass]="{ 'opacity-30': !subscription.filter_config.filter.body || !subscription.filter_config.filter.headers }">
					<svg width="14" height="14" class="fill-grey-60">
						<use xlink:href="#filter-icon"></use>
					</svg>
					<div class="text-10 font-medium">Filter</div>
				</div>
				<div class="flex flex-col items-center text-grey-60" [ngClass]="{ 'opacity-30': !subscription.alert_config }">
					<svg width="14" height="14" class="fill-grey-60">
						<use xlink:href="#alert-icon"></use>
					</svg>
					<div class="text-10 font-medium">Alert</div>
				</div>
				<div class="flex flex-col items-center text-grey-60" [ngClass]="{ 'opacity-30': !subscription.retry_config }">
					<svg width="14" height="14" class="fill-grey-60">
						<use xlink:href="#retry-icon"></use>
					</svg>
					<div class="text-10 font-medium">Retry</div>
				</div>
			</div>
		</div>
	</div>

	<ng-container *ngIf="privateService.activeProjectDetails?.type === 'outgoing'">
		<convoy-card className="pt-16px mb-16px" *ngFor="let subscription of subscriptions?.content">
			<div class="flex items-center justify-between pb-16px border-b-4 border-b-grey-10 cursor-pointer" routerLink="./" [queryParams]="{ id: subscription.uid }">
				<div class="flex items-center">
					<h4 class="pl-16px font-medium text-14">
						{{ subscription.name }}
					</h4>
				</div>
				<div class="flex items-center">
					<a class="pr-4 text-primary-100 text-12 flex items-center" routerLink="./" [queryParams]="{ id: subscription.uid }">
						View details
						<svg width="18" height="18" class="ml-2 fill-primary-100">
							<use xlink:href="#arrow-right-icon"></use>
						</svg>
					</a>
				</div>
			</div>

			<div class="flex items-end justify-between pb-8px pl-16px mt-8px" *ngIf="subscription?.endpoint_metadata" [ngClass]="{ 'border-b border-b-grey-10': privateService.activeProjectDetails?.type === 'incoming' }">
				<div class="w-full">
					<div class="text-grey-40 text-10 mb-12px">Endpoint</div>
					<div class="text-12">{{ subscription?.endpoint_metadata?.title }}</div>
				</div>
				<div class="w-full flex items-center">
					<div class="text-12 max-w-[220px] desktop:max-w-[158px] overflow-hidden whitespace-nowrap text-ellipsis">
						{{ subscription?.endpoint_metadata?.target_url }}
					</div>
					<convoy-copy-button [text]="subscription?.endpoint_metadata?.target_url || ''" size="md" notificationText="Endpoint URL has been copied to clipboard" className="ml-8px"></convoy-copy-button>
				</div>
				<div class="w-full" *ngIf="subscription?.endpoint_metadata?.secrets?.length">
					<div class="text-12 flex items-center whitespace-nowrap">
						Endpoint Secret
						<convoy-copy-button [text]="getEndpointSecret(subscription.endpoint_metadata?.secrets) || ''" size="md" notificationText="Endpoint secret has been copied to clipboard" className="ml-8px"></convoy-copy-button>
					</div>
				</div>
				<div class="flex items-center justify-end w-[50%]">
					<a class="mx-16px flex items-center text-12 text-primary-100 font-medium" [routerLink]="'/projects/' + projectId + '/endpoints/' + subscription.endpoint_metadata?.uid">
						<div class="whitespace-nowrap">Go to endpoint</div>
						<svg width="18" height="18" class="ml-2" fill="#477db3">
							<use xlink:href="#arrow-right-icon"></use>
						</svg>
					</a>
				</div>
			</div>
		</convoy-card>
	</ng-container>
</div>

<convoy-empty-state
	imgSrc="/assets/img/new-empty-state.png"
	heading="Create your first webhook subscription"
	description="Webhook subscriptions lets you define the source of your webhook and the destination where any webhook event should be sent. It is what allows Convoy to identify and proxy your webhooks."
	buttonText="Create Subscription"
	(onAction)="router.navigateByUrl('/projects/' + privateService.activeProjectDetails?.uid + '/subscriptions/new')"
	className="min-h-[65vh] mt-16px"
	id="subscriptions-empty-state"
	*ngIf="!isLoadindingSubscriptions && subscriptions?.content?.length === 0"
></convoy-empty-state>

<div convoy-modal *ngIf="shouldShowCreateSubscriptionModal || showUpdateSubscriptionModal" position="full" [id]="'subscriptionForm'" [title]="showUpdateSubscriptionModal ? 'Update Subscription' : 'Create Subscription'" (closeModal)="createSubscription('cancel')">
	<ng-container modalBody>
		<convoy-create-subscription showAction="true" (onAction)="createSubscription($event.action)" [action]="showUpdateSubscriptionModal ? 'update' : 'create'"></convoy-create-subscription>
	</ng-container>
</div>

<app-delete-modal *ngIf="showDeleteSubscriptionModal" [isLoading]="isDeletingSubscription" [deleteText]="'delete “' + activeSubscription?.name + '”'" (closeModal)="showDeleteSubscriptionModal = false" (deleteData)="deleteSubscripton()"></app-delete-modal>

<div convoy-modal *ngIf="!isLoadindingSubscriptions && activeSubscription?.uid" position="right" [id]="'subscription-details'" [title]="activeSubscription?.name || 'Subscription Details'" (closeModal)="closeModal()">
	<ng-container modalBody>
		<ul>
			<li convoy-list-item class="text-14 font-normal py-16px px-24px">
				<div class="w-[50%] text-grey-40">Subscription type</div>
				<div class="w-[50%] text-right capitalize">{{ activeSubscription?.type }}</div>
			</li>
			<li convoy-list-item class="text-14 font-normal py-16px px-24px" *ngIf="activeSubscription?.endpoint_metadata">
				<div class="w-[50%] text-grey-40">Endpoint</div>
				<div class="w-[50%] text-right text-ellipsis whitespace-nowrap overflow-hidden">{{ activeSubscription?.endpoint_metadata?.target_url }}</div>
			</li>
			<li convoy-list-item class="text-14 font-normal py-16px px-24px" *ngIf="activeSubscription?.type === 'incoming'">
				<div class="w-[50%] text-grey-40">Source</div>
				<a [routerLink]="'/projects/' + projectId + '/sources'" [queryParams]="{ id: activeSubscription?.uid }" class="w-[50%] font-medium text-primary-100 text-right underline">
					{{ activeSubscription?.source_metadata?.name }}
				</a>
			</li>
			<li convoy-list-item class="text-14 font-normal py-16px px-24px">
				<div class="w-[50%] text-grey-40">Created At</div>
				<div class="w-[50%] text-right">{{ activeSubscription?.created_at | date }}</div>
			</li>

			<li convoy-list-item class="text-14 font-normal py-16px px-24px items-start" *ngIf="privateService.activeProjectDetails?.type === 'outgoing'">
				<div class="w-[40%] flex items-center text-primary-100 text-12 whitespace-nowrap">
					Events Watched
					<svg width="18" height="18" class="ml-2 fill-primary-100">
						<use xlink:href="#arrow-right-icon"></use>
					</svg>
				</div>
				<div class="w-[60%] text-right">
					<div class="flex items-center justify-end flex-wrap">
						<convoy-tag type="grey" className="ml-4px mb-1 first-of-type:mr-0" *ngFor="let event of activeSubscription?.filter_config?.event_types">{{ event === '*' ? 'all events' : event }}</convoy-tag>
					</div>
				</div>
			</li>
		</ul>

		<div class="flex items-center justify-end mt-40px mr-24px">
			<button convoy-button size="sm" color="danger" fill="outline" class="py-8px px-12px text-12" (click)="showDeleteSubscriptionModal = true">
				Delete
				<svg width="18" height="18" class="ml-2 fill-danger-100">
					<use xlink:href="#delete-icon"></use>
				</svg>
			</button>
			<button convoy-button size="sm" class="py-8px px-12px text-12 ml-24px" [routerLink]="'/projects/' + projectId + '/subscriptions/' + activeSubscription?.uid">
				Edit
				<svg width="18" height="18" class="ml-8px" fill="currentColor">
					<use xlink:href="#edit-icon"></use>
				</svg>
			</button>
		</div>
	</ng-container>
</div>
