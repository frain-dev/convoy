<div>
	<div class="flex items-center mt-40px">
		<h2 class="text-12 font-medium text-new.gray-600 mr-8px">Event Deliveries</h2>
		<convoy-tooltip size="sm" position="right" type="white">
			<h4 class="mb-10px font-semibold text-12">Deliveries missing?</h4>
			<p>
				Your receiving endpoint possibly isn't subscribed for events,
				<ng-container *ngIf="portalToken">reach out to provider</ng-container>
				<ng-container *ngIf="!portalToken">
					check
					<span convoy-button fill="link" class="!inline-block text-12 !p-0" routerLink="../event-logs" [relativeTo]="route">Events Log</span>
					or subscribe your endpoint to events
					<span convoy-button fill="link" class="!inline-block text-12 !p-0" routerLink="../subscriptions/new" [relativeTo]="route">here</span>
					.
				</ng-container>
			</p>
		</convoy-tooltip>
	</div>

	<div class="flex py-20px items-start justify-between gap-x-16px">
		<div class="flex items-start gap-x-16px">
			<div class="flex flex-wrap items-center gap-x-16px gap-y-10px w-fit max-w-[750px]">
				<button convoy-button fill="outline" class="!p-10px border-new.primary-200" [ngClass]="{ 'text-primary-100 !bg-primary-500': queryParams?.sort === 'asc' }" (click)="toggleSortOrder()">
					<svg width="10" height="10" class="scale-105">
						<use xlink:href="#sort-icon"></use>
					</svg>
				</button>

				<div class="h-16px w-[1px] bg-new.gray-200"></div>

				<div class="flex gap-x-2px" *ngIf="queryParams?.startDate || queryParams?.endDate">
					<div class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Date</div>
					<div class="border border-new.primary-200 rounded-tr-22px rounded-br-22px px-10px py-6px text-new.gray-500 text-12 flex gap-6px items-center">
						{{ queryParams?.startDate | date: 'dd/MM/yy, h:mm a' }} - {{ queryParams?.endDate | date: 'dd/MM/yy, h:mm a' }}

						<button convoy-button (click)="clearFilters('startDate'); toggleFilter('Date', false)" fill="text" type="button" class="py-0 px-0 ml-4px">
							<svg width="14" height="14" class="fill-grey-40">
								<use xlink:href="#close-icon-2"></use>
							</svg>
						</button>
					</div>
				</div>

				<ng-container *ngIf="showFilter('Date')">
					<convoy-date-picker
						position="right-side"
						[show]="true"
						(selectedDateRange)="getSelectedDateRange($event); toggleFilter('Date', false)"
						(clearDates)="toggleFilter('Date', false)"
						[dateRangeValue]="{ startDate: queryParams?.startDate || '', endDate: queryParams?.endDate || '' }"
						#datePicker
					>
						<button dropdownTrigger convoy-button fill="outline" size="sm" class="border border-new.primary-200 rounded-tl-22px rounded-[0] rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Date</button>
					</convoy-date-picker>
				</ng-container>

				<div class="flex gap-x-2px" *ngIf="eventDeliveryFilteredByStatus.length">
					<div class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Status</div>
					<div class="border border-new.primary-200 last-of-type:rounded-tr-22px last-of-type:rounded-br-22px px-10px py-6px text-new.gray-500 text-12 flex gap-6px items-center" *ngFor="let status of eventDeliveryFilteredByStatus">
						{{ status || 'None' }}

						<button convoy-button (click)="removeStatusFilter(status)" fill="text" type="button" class="py-0 px-0 ml-4px">
							<svg width="14" height="14" class="fill-grey-40">
								<use xlink:href="#close-icon-2"></use>
							</svg>
						</button>
					</div>
				</div>

				<ng-container *ngIf="showFilter('Status')">
					<div convoy-dropdown size="md" position="right-side" [show]="true" #statusDropdown>
						<div dropdownTrigger class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Status</div>

						<ng-container dropdownOptions>
							<ul class="min-h-[100px] max-h-[200px] overflow-auto pb-10px">
								<li convoy-dropdown-option convoy-list-item *ngFor="let status of eventDeliveryStatuses" (click)="selectStatusFilter(status)" class="text-14 px-20px">
									<button convoy-button color="grey" fill="text" class="capitalize font-normal text-left w-full !justify-start text-12">
										{{ status || 'None' }}
									</button>
								</li>
							</ul>
						</ng-container>
					</div>
				</ng-container>

				<div class="flex gap-x-2px" *ngIf="eventDeliveriesSource">
					<div class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Source</div>
					<div class="border border-new.primary-200 rounded-tr-22px rounded-br-22px px-10px py-6px text-new.gray-500 text-12 flex gap-6px items-center">
						{{ eventDeliveriesSourceData?.name }}

						<button convoy-button (click)="eventDeliveriesSource = ''; toggleFilter('Source', false); clearFilters('sourceId')" fill="text" type="button" class="py-0 px-0 ml-4px">
							<svg width="14" height="14" class="fill-grey-40">
								<use xlink:href="#close-icon-2"></use>
							</svg>
						</button>
					</div>
				</div>

				<ng-container *ngIf="showFilter('Source')">
					<div convoy-dropdown size="md" position="right-side" [show]="true" #sourcesFilterDropdown [hidden]="portalToken || this.projectService.activeProjectDetails?.type === 'outgoing'">
						<div dropdownTrigger class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Sources</div>

						<div dropdownOptions>
							<ul class="min-h-[100px] max-h-[200px] overflow-auto">
								<li
									convoy-dropdown-option
									convoy-list-item
									*ngFor="let source of filterSources"
									(click)="eventDeliveriesSource = source.uid; eventDeliveriesSourceData = source; updateSourceFilter(); toggleFilter('Source', false)"
									class="text-14 px-20px"
									[ngClass]="{ 'text-primary-100 !bg-primary-500': queryParams?.sourceId === source.uid }"
								>
									<button convoy-button color="grey" fill="text" class="capitalize font-normal text-left w-full !justify-start text-12">
										{{ source.name }}
									</button>
								</li>
							</ul>
						</div>
					</div>
				</ng-container>

				<div class="flex gap-x-2px" *ngIf="eventDeliveriesEndpoint">
					<div class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Endpoint</div>
					<div class="border border-new.primary-200 rounded-tr-22px rounded-br-22px px-10px py-6px text-new.gray-500 text-12 flex gap-6px items-center">
						{{ eventDeliveriesEndpointData?.title || eventDeliveriesEndpoint }}

						<button convoy-button (click)="clearFilters('endpointId'); toggleFilter('Endpoint', false)" fill="text" type="button" class="py-0 px-0 ml-4px">
							<svg width="14" height="14" class="fill-grey-40">
								<use xlink:href="#close-icon-2"></use>
							</svg>
						</button>
					</div>
				</div>

				<ng-container *ngIf="showFilter('Endpoint')">
					<convoy-endpoint-filter
						*ngIf="!portalToken"
						position="right-side"
						[show]="true"
						[endpoint]="eventDeliveriesEndpoint"
						(clear)="clearFilters('endpointId')"
						(set)="eventDeliveriesEndpoint = $event.uid; eventDeliveriesEndpointData = $event; updateEndpointFilter(); toggleFilter('Endpoint', false)"
					>
						<button dropdownTrigger convoy-button size="sm" fill="outline" class="border border-new.primary-200 rounded-[0] rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Endpoint</button>
					</convoy-endpoint-filter>
				</ng-container>

				<div class="flex gap-x-2px" *ngIf="eventDelEventType">
					<div class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Event Type</div>
					<div class="border border-new.primary-200 rounded-tr-22px rounded-br-22px px-10px py-6px text-new.gray-500 text-12 flex gap-6px items-center">
						{{ eventDelEventType }}

						<button convoy-button (click)="clearFilters('eventType'); toggleFilter('Event Type', false)" fill="text" type="button" class="py-0 px-0 ml-4px">
							<svg width="14" height="14" class="fill-grey-40">
								<use xlink:href="#close-icon-2"></use>
							</svg>
						</button>
					</div>
				</div>

				<ng-container *ngIf="showFilter('Event type')">
					<div convoy-dropdown size="md" position="right-side" [show]="true" #eventTypeDropdown>
						<div dropdownTrigger class="border border-new.primary-200 rounded-tl-22px rounded-bl-22px px-10px py-6px text-new.primary-300 text-12">Event Type</div>

						<ng-container dropdownOptions>
							<div>
								<form class="border border-primary-400 h-36px px-14px py-0 max-w-[200px] w-full rounded-[10px] flex items-center bg-transparent">
									<img src="/assets/img/search-icon.svg" alt="search icon" class="mr-10px" />
									<input
										type="search"
										placeholder="Search event type"
										[(ngModel)]="eventsTypeSearchString"
										(change)="setEventType()"
										[ngModelOptions]="{ standalone: true }"
										class="w-full text-grey-40 outline-none bg-transparent text-12 font-normal"
										[ngClass]="{ 'bg-primary-500': eventsTypeSearchString != undefined && eventsTypeSearchString != '' }"
									/>
									<button *ngIf="eventsTypeSearchString">
										<img src="/assets/img/enter-icon.png" alt="enter icon" class="w-16px opacity-75" />
									</button>
								</form>
							</div>
						</ng-container>
					</div>
				</ng-container>
			</div>


			<div class="flex items-center gap-x-16px">
				<div convoy-dropdown size="sm" position="left">
					<button dropdownTrigger convoy-button fill="outline" texture="light" class="!px-10px !py-6px gap-8px !text-new.gray-400 border-new.primary-200 h-32px">
						<svg width="14" height="14" class="stroke-new.gray-400">
							<use xlink:href="#plus-icon"></use>
						</svg>

						<span *ngIf="!isAnyFilterSelected()">Set Filters</span>
					</button>

					<ul dropdownOptions>
						<li convoy-dropdown-option convoy-list-item *ngFor="let filterOption of filterOptions" (click)="toggleFilter(filterOption.name, true)" class="text-14 px-20px">
							<button convoy-button color="grey" fill="text" class="capitalize font-normal text-left w-full !justify-start text-12">
								{{ filterOption.name }}
							</button>
						</li>
					</ul>
				</div>
				<ng-container *ngIf="isAnyFilterSelected()">
					<div class="h-16px w-[1px] bg-new.gray-200"></div>

					<button convoy-button size="sm" texture="light" (click)="eventDeliveriesSource = ''; eventDeliveryFilteredByStatus = []; clearFilters()">Clear Filters</button>
				</ng-container>
			</div>

		</div>


		<div class="flex items-center gap-x-16px">
			<button
				convoy-button
				size="sm"
				class="px-10px py-6px border-primary-400"
				[disabled]="(!queryParams?.startDate || !queryParams?.endDate) && !queryParams?.endpointId && !queryParams?.eventId && !queryParams?.status && !queryParams?.sourceId"
				(click)="fetchRetryCount()"
			>
				Batch Retry
			</button>
			<div convoy-button size="sm" fill="outline" texture="light" class="px-6px relative">
				<label class="text-12 text-new.gray-500 block w-full capitalize whitespace-nowrap mr-6px" for="tailMode">Tail Events</label>
				<input
					type="checkbox"
					class="
						peer
						transition-all
						w-24px
						h-18px
						border border-new.primary-50
						rounded-4px
						checked:border-new.primary-400
						checked:bg-new.primary-25 checked:bg-[url(assets/img/check-icon-primary.svg)] checked:bg-[length:12px] checked:bg-center checked:bg-no-repeat
						focus:bottom-2
						focus:border-new.primary-400
						bg-white-100
					"
					name="enableTailMode"
					[checked]="enableTailMode"
					id="tailMode"
					(change)="toggleTailMode($event)"
				/>
			</div>
		</div>
	</div>


	<convoy-table-loader id="event_deliveries_loader" [tableHead]="eventDelTableHead" *ngIf="isloadingEventDeliveries"></convoy-table-loader>

	<!-- empty state  -->
	<div convoy-card class="py-60px rounded-8px" *ngIf="!isloadingEventDeliveries && (!displayedEventDeliveries || displayedEventDeliveries?.length === 0)">
		<div class="flex justify-center items-center p-40px flex-col">
			<img src="/assets/img/empty-state.svg" alt="empty state image" />
			<p class="mt-16px text-12 text-new.gray-500">No event to show here</p>
		</div>
	</div>

	<div class="min-h-[70vh] overflow-y-auto overflow-x-auto w-full min-w-[485px]" id="event-deliveries-table-container" *ngIf="!isloadingEventDeliveries && displayedEventDeliveries && displayedEventDeliveries.length > 0">
		<div convoy-card>
			<table convoy-table>
				<thead convoy-table-head>
					<ng-container *ngFor="let head of eventDelTableHead; let i = index">
						<th convoy-table-head-cell [class]="i === 0 ? 'pl-20px' : ''" *ngIf="projectService.activeProjectDetails?.type === 'outgoing' || i !== 1 || portalToken">{{ head }}</th>
					</ng-container>
				</thead>
				<tbody>
					<ng-container *ngFor="let eventDeliveriesGroup of displayedEventDeliveries; let i = index">
						<tr convoy-table-row [forDate]="true">
							<td convoy-table-cell [forDate]="true">{{ eventDeliveriesGroup.date }}</td>
							<td convoy-table-cell [forDate]="true"></td>
							<td convoy-table-cell [forDate]="true"></td>
							<td convoy-table-cell [forDate]="true"></td>
							<td convoy-table-cell [forDate]="true"></td>
							<td convoy-table-cell [forDate]="true"></td>
						</tr>
						<ng-container *ngFor="let eventDelivery of eventDeliveriesGroup.content; let index = index">
							<tr class="cursor-pointer" convoy-table-row *ngFor="let event of eventDelivery.eventDeliveries; let index = index" [id]="'eventDel' + i" [routerLink]="['./event-deliveries/' + event.uid]" [queryParams]="{ token: portalToken }">
								<td convoy-table-cell class="pl-16px relative w-140px">
									<img *ngIf="event.metadata.num_trials > event.metadata.retry_limit" src="assets/img/retry-icon.svg" alt="retry icon" title="manually retried" class="w-12px absolute top-[50%] -translate[3px] -translate-y-[50%] opacity-50" />
									<convoy-tag className="ml-20px" [color]="event.status | statuscolor">{{ event?.status }}</convoy-tag>
								</td>
								<td convoy-table-cell *ngIf="projectService.activeProjectDetails?.type === 'outgoing' || portalToken">
									<div convoy-tag class="bg-new.gray-50">{{ event.event_metadata.event_type }}</div>
								</td>

								<td convoy-table-cell>
									<div class="flex items-center">
										<ng-container *ngIf="projectService.activeProjectDetails?.type === 'incoming'">
											<span class="max-w-[146px] overflow-hidden overflow-ellipsis">
												{{ event?.source_metadata?.name || 'Rest API' }}
											</span>

											<span class="px-20px font-light">→</span>
										</ng-container>

										<span [class]="projectService.activeProjectDetails?.type === 'incoming' ? 'max-w-[146px] overflow-hidden overflow-ellipsis' : 'w-166px' + ' overflow-hidden overflow-ellipsis'">
											{{ event.endpoint_metadata.title }}
										</span>
										<!-- show this if CLI is the receiver -->
										<convoy-tag *ngIf="event.device_id" className="flex items-center">
											<svg width="16" height="14" class="mr-10px">
												<use xlink:href="#cli-icon"></use>
											</svg>
											CLI Device
										</convoy-tag>
									</div>
								</td>
								<td convoy-table-cell>{{ event.device_id ? '-' : event.metadata.num_trials }}</td>
								<td convoy-table-cell>{{ event?.status == 'Success' || event.metadata.num_trials >= event.metadata.retry_limit || event?.status == 'Discarded' ? '-' : (event.metadata.next_send_time | date: 'mediumTime') }}</td>
								<td convoy-table-cell>{{ event.created_at | date: 'mediumTime' }}</td>
								<td convoy-table-cell>
									<button
										convoy-button
										size="xs"
										texture="light"
										[disabled]="event.status !== 'Success' && event.status !== 'Failure' && event.status !== 'Discarded'"
										[title]="event.status !== 'Failure' && event.status !== 'Success' && event.status !== 'Discarded' ? 'You can not retry an event when it is scheduled or still processing.' : ''"
										(click)="event.status === 'Success' ? forceRetryEvent({ e: $event, index: this.index, eventDeliveryId: event.uid }) : retryEvent({ e: $event, index: this.index, eventDeliveryId: event.uid })"
									>
										<img src="assets/img/refresh-icon-primary.svg" alt="refresh icon" class="mr-10px" />
										{{ event.status === 'Success' ? 'Force Retry' : 'Retry' }}
									</button>
								</td>
								<td convoy-table-cell>
									<button size="xs" [routerLink]="'./event-deliveries/' + event.uid">
										<img src="assets/img/angle-arrow-right-primary.svg" alt="arrow right" class="h-16px" />
									</button>
								</td>
							</tr>
							<tr convoy-table-row [forDate]="true"></tr>
						</ng-container>
					</ng-container>
				</tbody>
			</table>
		</div>

		<!-- pagination -->
		<div class="pt-8px flex items-center justify-between px-10px" *ngIf="eventDeliveries?.pagination?.has_next_page || eventDeliveries?.pagination?.has_prev_page">
			<convoy-pagination [pagination]="eventDeliveries?.pagination" (paginate)="paginateEvents($event)"></convoy-pagination>
			<div class="text-grey-40 text-14">{{ eventDeliveries?.content?.length }} events</div>
		</div>
	</div>
</div>

<!-- batch retry modal  -->
<dialog #batchRetryDialog convoy-dialog position="center" size="sm">
	<div class="text-center py-30px">
		<img src="/assets/img/filter.gif" alt="filter icon" class="w-30px m-auto mb-16px" />
		<div class="text-center text-14 font-medium text-grey-60 mb-8px">The filters applied will affect</div>
		<div class="text-center text-12 font-semibold mb-32px">{{ batchRetryCount || 0 }} event deliver{{ batchRetryCount > 1 ? 'ies' : 'y' }}</div>
		<button convoy-button size="sm" [disabled]="isRetrying || batchRetryCount == 0" class="m-auto" (click)="batchRetryEvent()">{{ isRetrying ? 'Retrying Events...' : 'Yes, Apply' }}</button>
		<button convoy-button fill="clear" class="font-semibold m-auto mt-16px" (click)="dialog.nativeElement.close()">No, Cancel</button>
	</div>
</dialog>
