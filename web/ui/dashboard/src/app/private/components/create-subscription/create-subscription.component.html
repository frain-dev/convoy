<form class="pb-40px mt-40px relative" [formGroup]="subscriptionForm" (ngSubmit)="saveSubscription()">
	<convoy-loader *ngIf="isLoadingForm"></convoy-loader>

	<convoy-card className="px-24px py-24px mb-70px">
		<convoy-input-field>
			<label for="subscription-name" required="true" convoy-label>Subscription name</label>
			<input type="text" id="subscription-name" convoy-input autocomplete="subscription-name" formControlName="name" placeholder="e.g paystack-live" />
			<convoy-input-error *ngIf="subscriptionForm.get('name')?.touched && subscriptionForm.get('name')?.invalid">Enter new subscription name</convoy-input-error>
		</convoy-input-field>
		<div class="border-t border-grey-20 pt-24px mt-24px">
			<h3 class="font-semibold mb-24px">Set Configurations</h3>

			<ng-container *ngIf="showConfig('retry-config')">
				<div class="flex justify-between items-center mb-16px">
					<p class="text-14 font-medium text-grey-60 flex items-center">
						Retry Logic
						<convoy-tooltip size="sm" position="right" class="ml-4px">
							These are the specifications for the retry mechanism for your endpoints under this subscription. In Linear time retry, event retries are done in linear time, while in Exponential back off retry, events are retried progressively increasing the time
							before the next retry attempt.
						</convoy-tooltip>
					</p>
					<button convoy-button type="button" size="xs" fill="outline" color="grey" texture="light" (click)="toggleConfigForm('retry-config')">
						<img src="assets/img/svg/delete-icon.svg" alt="plus icon" />
					</button>
				</div>

				<div class="grid grid-cols-2 gap-x-6" formGroupName="retry_config">
					<convoy-input-field>
						<convoy-select
							[options]="retryLogicTypes"
							name="type"
							formControlName="type"
							label="Mechanism"
							placeholder="Select mechanism"
							(selectedOption)="subscriptionForm.get('retry_config')?.patchValue({ type: $event })"
							errorMessage="Select retry mechanism"
						></convoy-select>
					</convoy-input-field>
					<convoy-input-field>
						<label for="retry-logic-duration" convoy-label>Duration</label>
						<div class="relative">
							<input type="number" id="retry-logic-duration" convoy-input autocomplete="retry-logic-duration" formControlName="duration" placeholder="e.g 3" />
							<div class="absolute top-[50%] right-14px text-16 text-grey-100 opacity-40 translate-y-[-50%]">sec</div>
						</div>
						<convoy-input-error *ngIf="subscriptionForm.get('retry_config.duration')?.touched && subscriptionForm.get('retry_config.duration')?.invalid">Enter wait duration before retry</convoy-input-error>
					</convoy-input-field>
					<convoy-input-field>
						<label for="retry-logic-count" convoy-label>Limit</label>
						<input type="number" id="retry-logic-count" convoy-input autocomplete="retry-logic-count" formControlName="retry_count" placeholder="e.g 5" />
						<convoy-input-error *ngIf="subscriptionForm.get('retry_config.retry_count')?.touched && subscriptionForm.get('retry_config.retry_count')?.invalid">Enter max retry limit</convoy-input-error>
					</convoy-input-field>
				</div>
			</ng-container>

			<ng-container *ngIf="showConfig('alert-config')">
				<div class="flex justify-between items-center mb-16px">
					<p class="text-14 font-medium text-grey-60 flex items-center">
						Alert Rule
						<convoy-tooltip position="right" size="sm" class="ml-4px">This specifies the frequency at which notifications(emails, slack messages) would be sent when something happens to your subscirption.</convoy-tooltip>
					</p>
					<button convoy-button type="button" size="xs" fill="outline" color="grey" texture="light" (click)="toggleConfigForm('alert-config')">
						<img src="assets/img/svg/delete-icon.svg" alt="plus icon" />
					</button>
				</div>

				<div class="grid grid-cols-2 gap-6" formGroupName="alert_config">
					<convoy-input-field>
						<label for="alert-config-time" convoy-label>Time</label>
						<div class="relative">
							<input type="number" id="alert-config-time" convoy-input autocomplete="alert-config-time" formControlName="threshold" placeholder="e.g 30" />
							<div class="absolute top-[50%] right-14px text-16 text-grey-100 opacity-40 translate-y-[-50%]">sec</div>
						</div>
						<convoy-input-error *ngIf="subscriptionForm.get('alert_config.threshold')?.touched && subscriptionForm.get('alert_config.threshold')?.invalid">Enter error alert threshold</convoy-input-error>
					</convoy-input-field>
					<convoy-input-field>
						<label for="alert-config-count" convoy-label>Limit</label>
						<input type="number" id="alert-config-count" convoy-input autocomplete="alert-config-count" formControlName="count" placeholder="e.g 5" />
						<convoy-input-error *ngIf="subscriptionForm.get('alert_config.count')?.touched && subscriptionForm.get('alert_config.count')?.invalid">Enter error alert limit</convoy-input-error>
					</convoy-input-field>
				</div>
			</ng-container>

			<ng-container *ngIf="showConfig('filter')">
				<div class="border border-grey-20 rounded-4px p-16px mb-24px">
					<div class="flex justify-between items-center mb-14px">
						<h4 class="text-grey-60 font-medium">Events Filter</h4>
						<button convoy-button type="button" size="xs" fill="outline" color="grey" texture="light" (click)="toggleConfigForm('filter')">
							<img src="assets/img/svg/delete-icon.svg" alt="delete icon" />
						</button>
					</div>

					<div class="flex justify-between items-center">
						<a convoy-button size="sm" fill="text" type="button" class="font-medium !justify-start" href="https://getconvoy.io/docs/manual/subscriptions#subscription-filters" target="_blank" referrerpolicy="noreferrer">
							Learn more about filters here
							<svg width="24" height="24" class="ml-8px" class="fill-primary-100">
								<use xlink:href="#arrow-right-icon"></use>
							</svg>
						</a>
						<button convoy-button fill="text" size="sm" className="font-medium" type="button" (click)="setupFilter()">
							Setup Filter
							<svg width="16" height="16" class="ml-10px" class="fill-primary-100">
								<use xlink:href="#plus-icon"></use>
							</svg>
						</button>
					</div>
				</div>
			</ng-container>

			<div class="flex items-center">
				<ng-container *ngFor="let config of configurations">
					<button *ngIf="!config.show" convoy-button size="sm" fill="outline" color="grey" texture="light" type="button" class="mr-24px" (click)="toggleConfigForm(config.uid)">
						<img [src]="'assets/img/svg/' + config.uid + '-icon.svg'" class="mr-10px" [alt]="config.uid" />

						{{ config.name }}
						<img src="assets/img/svg/plus-icon.svg" class="ml-24px" alt="plus icon" />
					</button>
				</ng-container>
			</div>
		</div>
	</convoy-card>
	<ng-container *ngIf="projectType === 'incoming' && !token">
		<h3 class="font-semibold mb-6px">Source</h3>
		<p class="text-14 text-grey-60 mb-20px">Incoming event source this subscription is connected to.</p>
		<convoy-card className="px-24px py-24px mb-70px" *ngIf="!showCreateSourceModal">
			<convoy-select
				[options]="sources"
				name="source"
				formControlName="source_id"
				errorMessage="Select or create a source"
				label="Select from existing sources"
				placeholder="Select source"
				[required]="true"
				(selectedOption)="subscriptionForm.patchValue({ source_id: $event })"
			></convoy-select>
			<button convoy-button fill="text" type="button" class="mt-24px text-14 font-medium" (click)="showCreateSourceModal = true">
				<svg width="20" height="20" class="mr-8px" fill="currentColor">
					<use xlink:href="#plus-icon"></use>
				</svg>
				Create New Source
			</button>
		</convoy-card>
		<convoy-create-source *ngIf="showCreateSourceModal" (onAction)="$event?.action === 'close' ? (showCreateSourceModal = false) : onCreateSource($event.data); showCreateSourceModal = false">
			<button convoy-button fill="text" type="button" class="mt-24px text-14 font-medium" (click)="showCreateSourceModal = false">
				<svg width="20" height="20" class="mr-8px" fill="currentColor">
					<use xlink:href="#plus-icon"></use>
				</svg>
				Use Existing Source
			</button>
		</convoy-create-source>
	</ng-container>

	<h3 class="font-semibold mb-6px">Endpoint</h3>
	<p class="text-14 text-grey-60 mb-20px">Endpoint this subscription routes events into.</p>
	<convoy-card className="px-24px py-24px" *ngIf="!showCreateEndpointModal">
		<convoy-select
			className="mb-0 mt-24px"
			[options]="endPoints"
			name="endpoint"
			formControlName="endpoint_id"
			errorMessage="Select or create an endpoint"
			label="Select from existing endpoints"
			placeholder="Select endpoint"
			(selectedOption)="subscriptionForm.patchValue({ endpoint_id: $event })"
			[required]="true"
		></convoy-select>
		<button convoy-button fill="text" type="button" class="mt-24px text-14 font-medium" (click)="showCreateEndpointModal = true" *ngIf="!token">
			<svg width="20" height="20" class="mr-8px" fill="currentColor">
				<use xlink:href="#plus-icon"></use>
			</svg>
			Create New Endpoint
		</button>
	</convoy-card>
	<convoy-create-endpoint *ngIf="showCreateEndpointModal" (onAction)="$event.action === 'close' ? (showCreateEndpointModal = false) : onCreateEndpoint($event.data); showCreateEndpointModal = false">
		<button convoy-button fill="text" type="button" class="mt-24px text-14 font-medium" (click)="showCreateEndpointModal = false" *ngIf="!token">
			<svg width="20" height="20" class="mr-8px" fill="currentColor">
				<use xlink:href="#plus-icon"></use>
			</svg>
			Use Existing Endpoint
		</button>
	</convoy-create-endpoint>


	<div class="flex justify-end mt-32px">
		<button convoy-button class="mr-16px text-14 transition-all duration-300 hover:text-danger-100 hover:border-danger-100" fill="outline" type="button" (click)="cancel()">Cancel</button>
		<button convoy-button class="text-14">
			{{ isNewProjectRoute() ? 'Save and Proceed' : action == 'update' ? 'Update Subscription' : 'Create Subscription' }}
			<svg width="24" height="24" class="ml-8px" class="fill-white-100">
				<use xlink:href="#arrow-right-icon"></use>
			</svg>
		</button>
	</div>
</form>

<div class="absolute top-0 left-0 right-0 bottom-0 flex items-center justify-center bg-[rgba(0,0,0,0.5)] text-white-100 flex-col" *ngIf="showError">
	<p>An error occured while fetching app details</p>
	<button convoy-button size="sm" class="mt-20px" (click)="onAction.emit({ action: 'cancel' })">Close</button>
</div>

<div convoy-modal position="full" [title]="action === 'update' ? 'Edit Subscription Filter' : 'Create Subscription Filter'" *ngIf="showFilterForm" (closeModal)="showFilterForm = false">
	<div class="max-w-[1312px] m-auto">
		<convoy-create-subscription-filter [schema]="subscriptionForm.get('filter_config.filter')?.value" [action]="action" (filterSchema)="getFilterSchema($event)"></convoy-create-subscription-filter>
	</div>
</div>
<convoy-confirmation-modal *ngIf="confirmModal" (confirmAction)="onAction.emit({ action: 'cancel' })" (closeModal)="confirmModal = false"></convoy-confirmation-modal>
