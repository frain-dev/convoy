version: "3"

services:
    server-1:
        image: rtukpe/bench:v2
        command: ["./cmd", "server", "--config", "convoy.json", "--port", "3000"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            backendCluster:
                ipv4_address: 172.16.0.12
        ports:
            - "3000:3000"

    server-2:
        image: rtukpe/bench:v2
        command: ["./cmd", "server", "--config", "convoy.json", "--port", "3001"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            backendCluster:
                ipv4_address: 172.16.0.11
        ports:
            - "3001:3001"

    schedule:
        image: rtukpe/bench:v2
        command: ["./cmd", "scheduler", "--config", "convoy.json"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            - backendCluster

    worker:
        image: rtukpe/bench:v2
        command: ["./cmd", "worker", "--config", "convoy.json"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            - backendCluster

    stream:
        image: rtukpe/bench:v2
        command: ["./cmd", "stream", "--config", "convoy.json"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            - backendCluster

    ingest:
        image: rtukpe/bench:v2
        command: ["./cmd", "ingest", "--config", "convoy.json"]
        volumes:
            - ./convoy.json:/convoy.json
        restart: on-failure
        networks:
            - backendCluster

    caddy:
        image: caddy
        restart: on-failure
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./caddyfile:/etc/caddy/Caddyfile
        depends_on:
            - server-1
            - server-2
        networks:
            - backendCluster

networks:
    backendCluster:
        driver: bridge
        ipam:
            config:
                - subnet: 172.16.0.0/24

