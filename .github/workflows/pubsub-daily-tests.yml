name: Daily PubSub E2E Tests

permissions:
  contents: read

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  pubsub-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [1.24.x]
        postgres-version: ["15"]
        redis-version: ["6.2.6"]

    services:
      postgres:
        image: postgres:${{ matrix.postgres-version }}
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_DB: convoy
          POSTGRES_PASSWORD: postgres
          POSTGRES_MAX_CONNECTIONS: 2000
        options: --health-cmd pg_isready --health-interval 10ms --health-timeout 500ms --health-retries 15
      redis:
        image: redis:${{ matrix.redis-version }}
        ports:
          - 6379:6379
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Cache go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('go.sum') }}
          restore-keys: ${{ runner.os }}-go-${{ hashFiles('go.sum') }}

      - name: Check out code
        uses: actions/checkout@v5

      - name: Get and verify dependencies
        run: go mod download && go mod verify

      - name: Migrate Postgres
        run: go run ./cmd migrate up
        env:
          CONVOY_DB_SCHEME: postgres
          CONVOY_DB_HOST: localhost
          CONVOY_DB_USERNAME: postgres
          CONVOY_DB_PASSWORD: postgres
          CONVOY_DB_DATABASE: convoy
          CONVOY_DB_OPTIONS: sslmode=disable&connect_timeout=30
          CONVOY_DB_PORT: 5432
          CONVOY_REDIS_SCHEME: redis
          CONVOY_REDIS_HOST: localhost
          CONVOY_REDIS_PORT: 6379

      - name: Run PubSub E2E tests (testcontainers)
        run: make test_e2e_pubsub
        env:
          TEST_LICENSE_KEY:  ${{ secrets.CONVOY_TEST_LICENSE_KEY }}
          CONVOY_LICENSE_KEY: ${{ secrets.CONVOY_TEST_LICENSE_KEY }}
          CONVOY_LOCAL_ENCRYPTION_KEY: ${{ secrets.CONVOY_TEST_ENCRYPTION_KEY }}
          CONVOY_DISPATCHER_SKIP_PING_VALIDATION: true

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ðŸš¨ Daily PubSub E2E Tests Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Daily PubSub E2E Tests Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The daily PubSub/message broker E2E tests have failed. Please investigate."
                  }
                }
              ]
            }

      - name: Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v2
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "âœ… Daily PubSub E2E Tests Passed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Daily PubSub E2E Tests Passed*\n\nAll message broker tests completed successfully."
                  }
                }
              ]
            }
